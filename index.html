<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Anime Player</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.js"></script>
    <style>
        body, html { margin: 0; padding: 0; background: #000; height: 100%; overflow: hidden; }
        #artplayer { width: 100vw; height: 100vh; }
        .skip-btn {
            position: absolute; bottom: 80px; right: 20px; z-index: 100;
            background: orange; color: black; padding: 10px 20px;
            font-weight: bold; cursor: pointer; display: none; border-radius: 5px;
        }
    </style>
</head>
<body>

    <div id="artplayer"></div>
    <div id="skip-intro" class="skip-btn">SKIP INTRO</div>

    <script>
        // --- 1. CONFIGURATION & PROXY ---
        const PROXY = "https://proxy-pi-tawny.vercel.app/?url=";
        
        // This function simulates your API call to get the stream
        async function getEpisodeData(episodeId) {
            // Replace this with your actual fetch(`${your_api}/${episodeId}`)
            return {
                url: "https://haildrop77.pro/_v7/b145d2374990ae1c6729b473457964247200b0c4dfc266cd896c13c16c62b0176c9ddc773b9ab8e9957c6579e5ef9fbc10c92eb2275126f9dfabd86d42fdf73dd879b9a87ced51fc2c6b8bb389fb2d1c2b0405a67f28128f230594972df9cb66945a5f8f51629dbade11b96c674a291037a95b568ad1a2c6d896d45252b299be/master.m3u8",
                introStart: 0,
                introEnd: 89,
                nextEpisodeId: "1054528" // Example ID for auto-select
            };
        }

        // --- 2. PLAYER INITIALIZATION ---
        async function initPlayer() {
            const data = await getEpisodeData("current");
            const skipBtn = document.getElementById('skip-intro');

            const art = new Artplayer({
                container: '#artplayer',
                url: PROXY + encodeURIComponent(data.url),
                type: 'm3u8',
                autoplay: true,
                muted: false,
                fullscreen: true,
                pip: false, // Start with PiP OFF to prevent the Metadata error
                setting: true,
                customType: {
                    m3u8: function (video, url) {
                        if (Hls.isSupported()) {
                            const hls = new Hls();
                            hls.loadSource(url);
                            hls.attachMedia(video);
                            // Ensure metadata is loaded before trying to play
                            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                                video.play().catch(() => {
                                    art.notice.show = 'Click to Play';
                                });
                            });
                        }
                    },
                },
            });

            // --- 3. FIXING THE ERROR & HANDLING LOGIC ---

            // Only enable PiP and Fullscreen after video is actually ready
            art.on('video:canplay', () => {
                console.log("Metadata loaded. Safe to use PiP.");
                art.setting.update({ pip: true }); 
            });

            // Intro Skip Logic
            art.on('video:timeupdate', () => {
                if (art.currentTime >= data.introStart && art.currentTime <= data.introEnd) {
                    skipBtn.style.display = 'block';
                } else {
                    skipBtn.style.display = 'none';
                }
            });

            skipBtn.onclick = () => {
                art.currentTime = data.introEnd;
                skipBtn.style.display = 'none';
            };

            // Auto-Select Next Episode logic
            art.on('video:ended', () => {
                art.notice.show = 'Loading next episode...';
                setTimeout(() => {
                    // In a real app, you'd change the window.location or 
                    // art.switchUrl(new_proxied_url)
                    alert("Switching to Episode " + data.nextEpisodeId);
                }, 2000);
            });
        }

        initPlayer();
    </script>
</body>
</html>
