<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Private Anime Player</title>
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <style>
        :root { --bg: #0a0a0c; --accent: #6c5ce7; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; }
        .player-container { width: 100%; max-width: 1000px; margin: 20px auto; }
        #artplayer { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; overflow: hidden; }
        .controls-card { background: #16161a; padding: 20px; border-radius: 12px; border: 1px solid #2d2d2d; margin-top: 20px; }
        .status-badge { font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; background: rgba(108, 92, 231, 0.2); color: var(--accent); }
    </style>
</head>
<body>

<div class="container player-container">
    <h2 class="text-center my-4">My Private Player</h2>

    <div id="artplayer"></div>

    <div class="controls-card">
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label">Anime ID</label>
                <input type="text" id="anime-id" class="form-control bg-dark text-white border-secondary" placeholder="one-piece-100">
            </div>
            <div class="col-md-3">
                <label class="form-label">Episode</label>
                <input type="number" id="ep-no" class="form-control bg-dark text-white border-secondary" value="1">
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button onclick="loadStream()" class="btn btn-primary w-100" style="background: var(--accent); border:none;">
                    Play Now
                </button>
            </div>
        </div>
        <div class="mt-3">
            <span class="status-badge" id="status">Ready to stream</span>
        </div>
    </div>
</div>

<script>
    let art = new ArtPlayer({
        container: '#artplayer',
        url: '', // Initially empty
        fullscreen: true,
        autoplay: false,
        theme: '#6c5ce7',
        icons: {
            loading: '<img src="https://artplayer.org/assets/img/ploading.gif">',
        },
    });

    async function loadStream() {
        const animeId = document.getElementById('anime-id').value.trim();
        const epNo = document.getElementById('ep-no').value;
        const status = document.getElementById('status');

        if (!animeId) return alert("Please enter an Anime ID");

        try {
            status.innerText = "Fetching server information...";
            
            // 1. Get episode list to find the specific episode internal ID
            // Using your API structure: /api/episodes/{id}
            const epResp = await fetch(`https://1010-delta.vercel.app/api/episodes/${animeId}`);
            const epData = await epResp.json();
            
            if (!epData.success) throw new Error("Anime not found");

            const episode = epData.results.episodes.find(e => e.episode_no == epNo);
            if (!episode) throw new Error("Episode not found");

            // 2. Get the stream link
            // Using your API structure: /api/stream?id={animeId}?ep={epId}&server=hd-1&type=sub
            status.innerText = "Extracting streaming link...";
            const streamUrl = `https://1010-delta.vercel.app/api/stream?id=${animeId}?ep=${episode.data_id}&server=hd-1&type=sub`;
            
            const streamResp = await fetch(streamUrl);
            const streamData = await streamResp.json();

            const m3u8 = streamData.results.streamingLink[0].link.file;

            // 3. Load into ArtPlayer with Hls.js
            status.innerText = "Playing: " + episode.title;
            
            art.switchUrl(m3u8);
            
            // Re-attach HLS logic for the new URL
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(m3u8);
                hls.attachMedia(art.video);
            }

        } catch (error) {
            console.error(error);
            status.innerText = "Error: " + error.message;
        }
    }
</script>

</body>
</html>
